/*! phonepad.js build: 0.0.5. MIT Licensed. Copyright(c) 2014 Guillaume Gouchon <guillaume.gouchon@gmail.com> */
"use strict";function GamepadHelper(){var a=!1,b=[],c=[],d=null;this.init=function(a){if(d=a,"ongamepadconnected"in window||navigator.mozGamepads)window.addEventListener("gamepadconnected",j,!1),window.addEventListener("gamepaddisconnected",k,!1);else{var b=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;b?e():d.onPadNotSupported(Phonepad.PAD_TYPES.gamepad)}};var e=function(){a||(a=!0,g())},f=function(){},g=function(){i(),h()},h=function(){a&&(window.requestAnimationFrame?window.requestAnimationFrame(g):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(g):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(g))},i=function(){var a=navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(a){a:for(var e in b){var f=b[e];for(var g in a)if(f===a[g].id)continue a;b.splice(e,1),m(c[e])}a:for(var e in a){var h=a[e];if(null!=h&&e>=0){for(var g in b)if(h.id===b[g])continue a;b.push(h.id),l(h)}}c=[];for(var i in a){var h=a[i];null!=h&&i>=0&&(c.push(h),d.onCommandsReceived(h))}}},j=function(a){l(a.gamepad),e()},k=function(a){for(var b in c)if(c[b].index===a.gamepad.index){m(a.gamepad);break}0===c.length&&f()},l=function(a){c.push(a),d.onPlayerConnected(a.id,Phonepad.PAD_TYPES.gamepad)},m=function(a){c.splice(a.index,1),d.onPlayerDisconnected(newGamepad.id)}}function Network(){var a="warnode.com",b=81,c="",d="http://warnode.com:7070",e=function(a){var b=io.connect(d);b.emit("newGame"),b.on("gameId",function(b){f(b,a),a.onConnected(b)}),b.on("pId",function(b){a.onPlayerConnected(b,Phonepad.PAD_TYPES.phonepad)}),b.on("comm",function(b){a.onCommandsReceived(b)}),b.on("disconnect",function(){})},f=function(d,e){try{var f=new Peer(d,{host:a,port:b,path:c});f.on("connection",function(a){a.on("data",function(b){switch(b.type){case"pId":var c=JSON.parse(b.content);a.pId=c,e.onPlayerConnected(c,Phonepad.PAD_TYPES.phonepad);break;case"comm":var d=JSON.parse(b.content);e.onCommandsReceived(d)}}),a.on("close",function(){})})}catch(g){}};this.connect=function(a){e(a)}}function PhonepadCallbacks(){var a={padNotSupported:null,connected:null,playerConnected:null,playerDisconnected:null,commandsReceived:null};this.onPadNotSupported=function(b){null!=a.padNotSupported&&a.padNotSupported(b)},this.onConnected=function(b){null!=a.connected&&a.connected(b)},this.onPlayerConnected=function(b,c){null!=a.playerConnected&&a.playerConnected(b,c)},this.onPlayerDisconnected=function(b){null!=a.playerDisconnected&&a.playerDisconnected(b)},this.onCommandsReceived=function(b){null!=a.commandsReceived&&a.commandsReceived(b)},this.setListener=function(b,c){b in a&&(a[b]=c)}}var Phonepad=function(){function a(){var a=new PhonepadCallbacks,b=new Network,c=new GamepadHelper;return{on:function(b,c){a.setListener(b,c)},start:function(){b.connect(a),c.init(a)}}}var b;return{getInstance:function(c){return b||(b=a(c)),b}}}();Phonepad.PAD_TYPES={gamepad:0,phonepad:1};