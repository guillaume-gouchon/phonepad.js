/*! phonepad.js build: 0.0.1. MIT Licensed. Copyright(c) 2014 Guillaume Gouchon <guillaume.gouchon@gmail.com> */
"use strict";function GamepadHelper(){var a=!1,b=[],c=[],d=null;this.init=function(a){if(d=a,"ongamepadconnected"in window||navigator.mozGamepads)window.addEventListener("gamepadconnected",j,!1),window.addEventListener("gamepaddisconnected",k,!1);else{var b=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;b?e():d.onPadNotSupported(Phonepad.PAD_TYPES.gamepad)}};var e=function(){a||(a=!0,g())},f=function(){},g=function(){i(),h()},h=function(){a&&(window.requestAnimationFrame?window.requestAnimationFrame(g):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(g):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(g))},i=function(){var a=navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(a){a:for(var e in b){var f=b[e];for(var g in a)if(f===a[g].id)continue a;delete b[e],m(c[e])}c=[];for(var h=!1,i=0;i<a.length;i++)null!==a[i]&&a[i].id!==b[i]&&(h=!0,b[i]=a[i].id),a[i]&&c.push(a[i]);if(h)for(var j in c)d.onCommandsReceived(c[j])}},j=function(a){l(a.gamepad),e()},k=function(a){for(var b in c)if(c[b].index===a.gamepad.index){m(a.gamepad);break}0===c.length&&f()},l=function(a){c.push(a),d.onPlayerConnected(a.id,Phonepad.PAD_TYPES.gamepad)},m=function(a){c.splice(a.index,1)}}function Network(){var a="609xv5np9cu15rk9",b="http://warnode.com:7070",c=function(a){var c=io.connect(b);c.emit("newGame"),c.on("gameId",function(b){d(b,a),a.onConnected(b)}),c.on("pId",function(b){a.onPlayerConnected(b,Phonepad.PAD_TYPES.phonepad)}),c.on("comm",function(b){a.onCommandsReceived(b)}),c.on("disconnect",function(b){a.onPlayerDisconnected(b)})},d=function(b,c){try{var d=new Peer(b,{key:a});d.on("connection",function(a){a.on("data",function(b){switch(b.type){case"pId":var d=JSON.parse(b.content);a.pId=d,c.onPlayerConnected(d,Phonepad.PAD_TYPES.phonepad);break;case"comm":var e=JSON.parse(b.content);c.onCommandsReceived(e)}}),a.on("close",function(){c.onPlayerDisconnected(a.pId)})})}catch(e){}};this.connect=function(a){c(a)}}function PhonepadCallbacks(){var a={padNotSupported:null,connected:null,playerConnected:null,playerDisconnected:null,commandsReceived:null};this.onPadNotSupported=function(b){null!==a.padNotSupported&&a.padNotSupported(b)},this.onConnected=function(b){null!==a.connected&&a.connected(b)},this.onPlayerConnected=function(b,c){null!==a.playerConnected&&a.playerConnected(b,c)},this.onPlayerDisconnected=function(b){null!==a.playerDisconnected&&a.playerDisconnected(b)},this.onCommandsReceived=function(b){null!==a.commandsReceived&&a.commandsReceived(b)},this.setListener=function(b,c){b in a&&(a[b]=c)}}var Phonepad=function(){function a(){var a=new PhonepadCallbacks,b=new Network,c=new GamepadHelper;return{on:function(b,c){a.setListener(b,c)},start:function(){b.connect(a),c.init(a)}}}var b;return{getInstance:function(c){return b||(b=a(c)),b}}}();Phonepad.PAD_TYPES={gamepad:0,phonepad:1};